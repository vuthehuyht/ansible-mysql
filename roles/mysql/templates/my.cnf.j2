# MySQL Configuration for {{ mysql_environment | upper }} Environment
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

[mysqld]
# Basic Settings
user = mysql
pid-file = /var/run/mysqld/mysqld.pid
socket = {{ mysql_socket }}
port = {{ mysql_port }}
basedir = {{ mysql_basedir }}
datadir = {{ mysql_datadir }}
tmpdir = /tmp
lc-messages-dir = {{ mysql_basedir }}/share
bind-address = {{ mysql_bind_address }}

# Environment: {{ mysql_environment | upper }}
{% if mysql_environment == 'dev' %}
# Development Environment Settings
{% elif mysql_environment == 'prod' %}
# Production Environment Settings
{% endif %}

# Skip external locking
skip-external-locking

# Connection Settings
max_connections = {{ mysql_max_connections | default(151) }}
{% if mysql_max_user_connections is defined %}
max_user_connections = {{ mysql_max_user_connections }}
{% endif %}

# Timeout Settings
{% if mysql_wait_timeout is defined %}
wait_timeout = {{ mysql_wait_timeout }}
{% endif %}
{% if mysql_interactive_timeout is defined %}
interactive_timeout = {{ mysql_interactive_timeout }}
{% endif %}

# Fine Tuning
key_buffer_size = {{ mysql_key_buffer_size }}
max_allowed_packet = {{ mysql_max_allowed_packet }}
thread_stack = {{ mysql_thread_stack }}
thread_cache_size = {{ mysql_thread_cache_size }}
myisam-recover-options = {{ mysql_myisam_recover_options }}

{% if mysql_table_open_cache is defined %}
table_open_cache = {{ mysql_table_open_cache }}
{% endif %}
{% if mysql_sort_buffer_size is defined %}
sort_buffer_size = {{ mysql_sort_buffer_size }}
{% endif %}
{% if mysql_read_buffer_size is defined %}
read_buffer_size = {{ mysql_read_buffer_size }}
{% endif %}
{% if mysql_read_rnd_buffer_size is defined %}
read_rnd_buffer_size = {{ mysql_read_rnd_buffer_size }}
{% endif %}
{% if mysql_join_buffer_size is defined %}
join_buffer_size = {{ mysql_join_buffer_size }}
{% endif %}

# Query Cache Configuration
query_cache_limit = {{ mysql_query_cache_limit }}
query_cache_size = {{ mysql_query_cache_size }}

# Logging Configuration
log-error = /var/log/mysql/error.log
{% if mysql_error_log_verbosity is defined %}
log_error_verbosity = {{ mysql_error_log_verbosity }}
{% endif %}

# General Query Log
{% if mysql_general_log_enabled is defined and mysql_general_log_enabled %}
general_log = 1
general_log_file = {{ mysql_general_log_file | default('/var/log/mysql/general.log') }}
{% else %}
general_log = 0
{% endif %}

# Slow Query Log
{% if mysql_slow_query_log_enabled is defined and mysql_slow_query_log_enabled %}
slow_query_log = 1
slow_query_log_file = {{ mysql_slow_query_log_file | default('/var/log/mysql/slow.log') }}
long_query_time = {{ mysql_long_query_time | default(2) }}
{% if mysql_log_queries_not_using_indexes is defined and mysql_log_queries_not_using_indexes %}
log_queries_not_using_indexes = 1
{% endif %}
{% else %}
slow_query_log = 0
{% endif %}

# Binary Logging
{% if mysql_log_bin_enabled is defined and mysql_log_bin_enabled %}
log_bin = {{ mysql_log_bin_basename | default('/var/log/mysql/mysql-bin') }}
expire_logs_days = {{ mysql_expire_logs_days }}
max_binlog_size = {{ mysql_max_binlog_size }}
{% if mysql_binlog_format is defined %}
binlog_format = {{ mysql_binlog_format }}
{% endif %}
{% if mysql_server_id is defined %}
server_id = {{ mysql_server_id }}
{% endif %}
{% if mysql_log_slave_updates is defined and mysql_log_slave_updates %}
log_slave_updates = 1
{% endif %}
{% else %}
# Binary logging disabled
{% endif %}

# InnoDB Settings
innodb_buffer_pool_size = {{ mysql_innodb_buffer_pool_size }}
innodb_log_file_size = {{ mysql_innodb_log_file_size }}
innodb_buffer_pool_instances = {{ mysql_innodb_buffer_pool_instances }}
innodb_log_buffer_size = {{ mysql_innodb_log_buffer_size }}
{% if mysql_innodb_flush_method is defined %}
innodb_flush_method = {{ mysql_innodb_flush_method }}
{% endif %}
{% if mysql_innodb_file_per_table is defined and mysql_innodb_file_per_table %}
innodb_file_per_table = 1
{% endif %}

# Security Settings
sql_mode = {{ mysql_sql_mode }}
{% if mysql_local_infile_enabled is defined and not mysql_local_infile_enabled %}
local_infile = 0
{% endif %}
{% if mysql_symbolic_links_enabled is defined and not mysql_symbolic_links_enabled %}
symbolic_links = 0
{% endif %}

# Character Set
character-set-server = {{ mysql_character_set }}
collation-server = {{ mysql_collation }}

# Secure file operations
secure_file_priv = {{ mysql_secure_file_priv }}

# Performance Schema
{% if mysql_performance_schema_enabled is defined %}
performance_schema = {{ '1' if mysql_performance_schema_enabled else '0' }}
{% endif %}

[mysql]
default-character-set = {{ mysql_character_set }}

[client]
default-character-set = {{ mysql_character_set }}
socket = {{ mysql_socket }}
port = {{ mysql_port }}

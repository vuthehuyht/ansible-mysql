# Chrony configuration for MySQL servers
# Environment: {{ mysql_environment | upper }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

# NTP Servers - sử dụng servers địa phương cho Vietnam
{% for server in mysql_ntp_servers %}
server {{ server }} iburst
{% endfor %}

# Fallback servers
server 0.asia.pool.ntp.org iburst
server 1.asia.pool.ntp.org iburst

# Record the rate at which the system clock gains/loses time
driftfile /var/lib/chrony/drift

# Allow the system clock to be stepped in the first three updates
# if its offset is larger than 1 second
makestep 1.0 3

# Enable kernel synchronization of the real-time clock (RTC)
rtcsync

# Specify file containing keys for NTP authentication
keyfile /etc/chrony/chrony.keys

# Environment specific settings
{% if mysql_environment == 'prod' %}
# Production: Strict time sync for database operations
# Maximum allowed offset before correction
maxupdateskew 10.0

# Log time sync events for production monitoring
logdir /var/log/chrony
log tracking measurements statistics

# Minimum and maximum polling intervals
minpoll 6
maxpoll 10
{% elif mysql_environment == 'dev' %}
# Development: More flexible time sync
maxupdateskew 100.0

# Less frequent logging for development
logdir /var/log/chrony
log tracking

# Wider polling range
minpoll 4
maxpoll 12
{% endif %}

# Allow chrony to serve time to clients on local network
{% if mysql_allow_ntp_clients | default(false) %}
# Allow NTP client access from local network
allow {{ mysql_ntp_client_network | default('192.168.0.0/16') }}
{% endif %}

# Leap second handling
leapsectz right/UTC

# Command port for chronyc
cmdport 323

# Disable command port access from network
cmdallow 127.0.0.1
cmdallow ::1

# Set the maximum number of samples to keep for each source
maxsamples 64

# MySQL specific optimizations
{% if mysql_environment == 'prod' %}
# For production MySQL:
# - Tight time sync (±100ms)
# - Frequent checks
# - Immediate step corrections for large offsets
corrtimeratio 10.0
{% endif %}

# Local stratum 10 clock as fallback
local stratum 10

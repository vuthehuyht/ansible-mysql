#!/bin/bash
# MySQL safe helper script
# Environment: {{ mysql_environment | upper }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

# Create runtime directory
mkdir -p /var/run/mysqld
chown mysql:mysql /var/run/mysqld
chmod 755 /var/run/mysqld

# Create log directory if not exists
mkdir -p /var/log/mysql
chown mysql:mysql /var/log/mysql
chmod 755 /var/log/mysql

{% if mysql_environment == 'dev' %}
# Development: Verbose logging
echo "$(date): MySQL safe helper - Development mode" >> /var/log/mysql/mysqld_safe.log
{% elif mysql_environment == 'prod' %}
# Production: Minimal logging
echo "$(date): MySQL safe helper started" >> /var/log/mysql/mysqld_safe.log
{% endif %}

# Verify MySQL directories exist
if [ ! -d "{{ mysql_datadir }}" ]; then
    echo "ERROR: MySQL data directory {{ mysql_datadir }} does not exist"
    exit 1
fi

# Check if MySQL binary exists
if [ ! -x "{{ mysql_install_dir }}/bin/mysqld" ]; then
    echo "ERROR: MySQL binary {{ mysql_install_dir }}/bin/mysqld not found or not executable"
    exit 1
fi

{% if mysql_environment == 'dev' %}
# Development: Additional checks
echo "$(date): Data directory: {{ mysql_datadir }}" >> /var/log/mysql/mysqld_safe.log
echo "$(date): Install directory: {{ mysql_install_dir }}" >> /var/log/mysql/mysqld_safe.log
{% endif %}

exit 0

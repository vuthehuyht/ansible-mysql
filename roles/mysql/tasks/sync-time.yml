---
# Tasks Ä‘á»ƒ Ä‘á»“ng bá»™ thá»i gian há»‡ thá»‘ng cho MySQL

- name: Kiá»ƒm tra timezone hiá»‡n táº¡i
  command: timedatectl show --property=Timezone --value
  register: current_timezone
  changed_when: false
  tags: [time-sync, timezone]

- name: Hiá»ƒn thá»‹ thÃ´ng tin thá»i gian hiá»‡n táº¡i
  debug:
    msg: |
      ğŸ• Current System Time Information:
      - Current timezone: {{ current_timezone.stdout }}
      - Target timezone: {{ mysql_timezone }}
      - NTP service: {{ mysql_ntp_service }}
  tags: [time-sync, info]

- name: CÃ i Ä‘áº·t chrony cho time synchronization
  package:
    name: chrony
    state: present
    update_cache: yes
  tags: [time-sync, packages]

- name: Cáº¥u hÃ¬nh chrony vá»›i NTP servers
  template:
    src: chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify: restart chrony
  tags: [time-sync, config]

- name: Äáº£m báº£o chrony service Ä‘ang cháº¡y
  systemd:
    name: chrony
    state: started
    enabled: yes
    daemon_reload: yes
  tags: [time-sync, service]

- name: Stop systemd-timesyncd (conflict vá»›i chrony)
  systemd:
    name: systemd-timesyncd
    state: stopped
    enabled: no
  failed_when: false  # KhÃ´ng fail náº¿u service khÃ´ng tá»“n táº¡i
  tags: [time-sync, service]

- name: Cáº¥u hÃ¬nh timezone cho há»‡ thá»‘ng
  timezone:
    name: "{{ mysql_timezone }}"
  notify: restart chrony
  tags: [time-sync, timezone]

- name: Kiá»ƒm tra vÃ  Ä‘á»“ng bá»™ thá»i gian ngay láº­p tá»©c
  command: chrony sources -v
  register: chrony_sources
  changed_when: false
  failed_when: false
  tags: [time-sync, verify]

- name: Force time synchronization
  command: chronyc makestep
  register: time_sync_result
  failed_when: false
  tags: [time-sync, force-sync]

- name: Chá» chrony Ä‘á»“ng bá»™
  wait_for:
    timeout: 10
  tags: [time-sync]

- name: Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘á»“ng bá»™ thá»i gian
  command: timedatectl status
  register: timedatectl_status
  changed_when: false
  tags: [time-sync, verify]

- name: Hiá»ƒn thá»‹ tráº¡ng thÃ¡i time synchronization
  debug:
    msg: |
      ğŸ• TIME SYNCHRONIZATION STATUS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ“‹ System Time Information:
      {{ timedatectl_status.stdout }}
      
      ğŸ“¡ Chrony Sources:
      {% if chrony_sources.stdout is defined %}
      {{ chrony_sources.stdout }}
      {% else %}
      Chrony sources check failed - may need time to initialize
      {% endif %}
      
      âš¡ Synchronization Result:
      {% if time_sync_result.rc == 0 %}
      âœ… Time sync successful
      {% else %}
      âš ï¸  Time sync may need more time to complete
      {% endif %}
      
      ğŸ¯ Configuration Applied:
      - Timezone: {{ mysql_timezone }}
      - NTP Service: chrony
      - Auto-sync: enabled
  tags: [time-sync, report]

- name: Cáº£nh bÃ¡o náº¿u thá»i gian chÆ°a Ä‘á»“ng bá»™
  debug:
    msg: |
      âš ï¸  TIME SYNCHRONIZATION WARNING
      
      Time sync may not be complete yet. This is normal for first setup.
      
      ğŸ“‹ Post-installation checks:
      1. Wait 2-3 minutes for full sync
      2. Check status: timedatectl status
      3. Check sources: chrony sources -v
      4. Manual sync if needed: chronyc makestep
      
      ğŸ’¡ For MySQL:
      - Accurate time is critical for replication
      - Log timestamps must be consistent
      - Authentication timeouts depend on accurate time
  when: 
    - time_sync_result.rc != 0 or chrony_sources.rc != 0
  tags: [time-sync, warning]

- name: Validate timezone cho MySQL
  fail:
    msg: |
      âŒ TIMEZONE VALIDATION FAILED
      
      Current timezone: {{ current_timezone.stdout }}
      Expected timezone: {{ mysql_timezone }}
      
      Please verify timezone setting and run again.
  when: 
    - current_timezone.stdout != mysql_timezone
    - mysql_validate_timezone | default(true)
  tags: [time-sync, validation]

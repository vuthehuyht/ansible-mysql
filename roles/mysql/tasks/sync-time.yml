---
# Tasks ƒë·ªÉ ƒë·ªìng b·ªô th·ªùi gian h·ªá th·ªëng cho MySQL

- name: Ki·ªÉm tra timezone hi·ªán t·∫°i
  command: tim- name: Ki·ªÉm tra timezone ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p ƒë√∫ng
  fail:
    msg: "‚ùå Timezone mismatch: {{ current_timezone.stdout }} ‚â† {{ mysql_timezone }}"
  when: 
    - current_timezone.stdout != mysql_timezone
    - mysql_validate_timezone | default(true)
  tags: [time-sync, validation] --property=Timezone --value
  register: current_timezone
  changed_when: false
  tags: [time-sync, timezone]

- name: Hi·ªÉn th·ªã th√¥ng tin th·ªùi gian hi·ªán t·∫°i
  debug:
    msg: "üïê Timezone: {{ current_timezone.stdout }} ‚Üí {{ mysql_timezone }} | NTP: {{ mysql_ntp_service }}"
  tags: [time-sync, info]

- name: C√†i ƒë·∫∑t chrony cho time synchronization
  package:
    name: chrony
    state: present
    update_cache: yes
  tags: [time-sync, packages]

- name: C·∫•u h√¨nh chrony v·ªõi NTP servers
  template:
    src: chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify: restart chrony
  tags: [time-sync, config]

- name: ƒê·∫£m b·∫£o chrony service ƒëang ch·∫°y
  systemd:
    name: chrony
    state: started
    enabled: yes
    daemon_reload: yes
  tags: [time-sync, service]

- name: Stop systemd-timesyncd (conflict v·ªõi chrony)
  systemd:
    name: systemd-timesyncd
    state: stopped
    enabled: no
  failed_when: false  # Kh√¥ng fail n·∫øu service kh√¥ng t·ªìn t·∫°i
  tags: [time-sync, service]

- name: C·∫•u h√¨nh timezone cho h·ªá th·ªëng
  timezone:
    name: "{{ mysql_timezone }}"
  notify: restart chrony
  tags: [time-sync, timezone]

- name: Ki·ªÉm tra v√† ƒë·ªìng b·ªô th·ªùi gian ngay l·∫≠p t·ª©c
  command: chrony sources -v
  register: chrony_sources
  changed_when: false
  failed_when: false
  tags: [time-sync, verify]

- name: Force time synchronization
  command: chronyc makestep
  register: time_sync_result
  failed_when: false
  tags: [time-sync, force-sync]

- name: Ch·ªù chrony ƒë·ªìng b·ªô
  wait_for:
    timeout: 10
  tags: [time-sync]

- name: Ki·ªÉm tra tr·∫°ng th√°i ƒë·ªìng b·ªô th·ªùi gian
  command: timedatectl status
  register: timedatectl_status
  changed_when: false
  tags: [time-sync, verify]

- name: Hi·ªÉn th·ªã tr·∫°ng th√°i time synchronization
  debug:
    msg: |
      üïê TIME SYNC: {{ time_sync_result.rc == 0 | ternary('‚úÖ Success', '‚ö†Ô∏è Pending') }}
      Timezone: {{ mysql_timezone }} | NTP: chrony enabled
  tags: [time-sync, report]

- name: C·∫£nh b√°o n·∫øu th·ªùi gian ch∆∞a ƒë·ªìng b·ªô
  debug:
    msg: "‚ö†Ô∏è Time sync pending - wait 2-3 minutes for completion"
      2. Check status: timedatectl status
      3. Check sources: chrony sources -v
      4. Manual sync if needed: chronyc makestep
      
      üí° For MySQL:
      - Accurate time is critical for replication
      - Log timestamps must be consistent
      - Authentication timeouts depend on accurate time
  when: 
    - time_sync_result.rc != 0 or chrony_sources.rc != 0
  tags: [time-sync, warning]

- name: Validate timezone cho MySQL
  fail:
    msg: |
      ‚ùå TIMEZONE VALIDATION FAILED
      
      Current timezone: {{ current_timezone.stdout }}
      Expected timezone: {{ mysql_timezone }}
      
      Please verify timezone setting and run again.
  when: 
    - current_timezone.stdout != mysql_timezone
    - mysql_validate_timezone | default(true)
  tags: [time-sync, validation]

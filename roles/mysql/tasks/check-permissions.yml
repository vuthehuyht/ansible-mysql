---
# Tasks Ä‘á»ƒ kiá»ƒm tra quyá»n vÃ  user permissions

- name: Kiá»ƒm tra user hiá»‡n táº¡i
  command: whoami
  register: current_user
  changed_when: false
  tags: [validation, permissions]

- name: Kiá»ƒm tra quyá»n root trá»±c tiáº¿p
  command: id -u
  register: user_id
  changed_when: false
  tags: [validation, permissions]

- name: Kiá»ƒm tra kháº£ nÄƒng sudo
  command: sudo -n true
  register: sudo_check
  failed_when: false
  changed_when: false
  tags: [validation, permissions]

- name: Hiá»ƒn thá»‹ thÃ´ng tin user vÃ  quyá»n
  debug:
    msg: |
      ğŸ‘¤ User Information:
      - Current user: {{ current_user.stdout }}
      - User ID: {{ user_id.stdout }}
      - Is root: {{ (user_id.stdout == '0') | ternary('Yes', 'No') }}
      - Sudo available: {{ (sudo_check.rc == 0) | ternary('Yes', 'No') }}
      - Become method: {{ ansible_become_method | default('not configured') }}
      - Become user: {{ ansible_become_user | default('not configured') }}
  tags: [validation, permissions]

- name: Cáº£nh bÃ¡o náº¿u khÃ´ng pháº£i root vÃ  khÃ´ng cÃ³ sudo
  fail:
    msg: |
      âŒ INSUFFICIENT PERMISSIONS
      
      User: {{ current_user.stdout }} (UID: {{ user_id.stdout }})
      Root: {{ (user_id.stdout == '0') | ternary('Yes', 'No') }} | Sudo: {{ (sudo_check.rc == 0) | ternary('Yes', 'No') }}
      
      ğŸ”§ Quick Fix:
      sudo echo "{{ current_user.stdout }} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/{{ current_user.stdout }}
      
      Or run with: ansible-playbook deploy-dev.yml -b -K
  when: 
    - user_id.stdout != '0'
    - sudo_check.rc != 0
    - not ansible_become | default(false)
  tags: [validation, permissions]

- name: ThÃ´ng bÃ¡o thÃ nh cÃ´ng vá» quyá»n
  debug:
    msg: |
      âœ… PERMISSION CHECK PASSED
      
      {% if user_id.stdout == '0' %}
      Access: Root user (UID 0) - Direct admin access
      {% elif sudo_check.rc == 0 %}
      Access: User '{{ current_user.stdout }}' with sudo privileges
      {% elif ansible_become | default(false) %}
      Access: Ansible become configured ({{ ansible_become_method | default('sudo') }})
      {% endif %}
      
      ğŸ”§ Ready to proceed with MySQL installation
  when: 
    - user_id.stdout == '0' or sudo_check.rc == 0 or ansible_become | default(false)
  tags: [validation, permissions]

- name: Cáº£nh bÃ¡o cho environment production vá»›i user thÆ°á»ng
  debug:
    msg: |
      âœ… PRODUCTION SECURITY BEST PRACTICE
      
      Using non-root user '{{ current_user.stdout }}' with sudo - RECOMMENDED!
      
      ğŸ”’ Security: âœ… Least privilege | âœ… Audit trail | âœ… Reduced attack surface
      ğŸ“‹ Requirements: âœ… Sudo access | âœ… Passwordless sudo | âœ… SSH keys
      ï¿½ Ready for: Package install, User creation, Service management, OS tuning
  when: 
    - mysql_environment == 'prod'
    - user_id.stdout != '0'
    - sudo_check.rc == 0 or ansible_become | default(false)
  tags: [validation, permissions, security]

- name: Kiá»ƒm tra quyá»n ghi vÃ o thÆ° má»¥c quan trá»ng
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /tmp/mysql-ansible-test
  register: directory_test
  failed_when: false
  tags: [validation, permissions]

- name: Dá»n dáº¹p test directory
  file:
    path: /tmp/mysql-ansible-test
    state: absent
  tags: [validation, permissions]

- name: Cáº£nh bÃ¡o náº¿u khÃ´ng thá»ƒ táº¡o directory
  debug:
    msg: |
      âš ï¸  WARNING: Directory creation test failed
      Check filesystem permissions and disk space before proceeding.
  when: directory_test.failed | default(false)
  tags: [validation, permissions]

- name: Kiá»ƒm tra cÃ¡c lá»‡nh cáº§n thiáº¿t cÃ³ sáºµn khÃ´ng
  command: which {{ item }}
  register: command_check
  failed_when: false
  changed_when: false
  loop:
    - sudo
    - systemctl
    - wget
    - tar
    - groupadd
    - useradd
  tags: [validation, commands]

- name: BÃ¡o cÃ¡o cÃ¡c lá»‡nh thiáº¿u
  debug:
    msg: |
      ğŸ“‹ Command Check:
      {% for result in command_check.results %}
      {{ result.item }}: {{ (result.rc == 0) | ternary('âœ…', 'âŒ') }}{% if not loop.last %} | {% endif %}
      {% endfor %}
      
      Status: {{ (command_check.results | selectattr('rc', 'ne', 0) | list | length > 0) | ternary('âš ï¸ Some commands missing', 'âœ… All commands available') }}
  tags: [validation, commands]

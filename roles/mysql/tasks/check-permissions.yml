---
# Tasks Ä‘á»ƒ kiá»ƒm tra quyá»n vÃ  user permissions

- name: Kiá»ƒm tra user hiá»‡n táº¡i
  command: whoami
  register: current_user
  changed_when: false
  tags: [validation, permissions]

- name: Kiá»ƒm tra quyá»n root trá»±c tiáº¿p
  command: id -u
  register: user_id
  changed_when: false
  tags: [validation, permissions]

- name: Kiá»ƒm tra kháº£ nÄƒng sudo
  command: sudo -n true
  register: sudo_check
  failed_when: false
  changed_when: false
  tags: [validation, permissions]

- name: Hiá»ƒn thá»‹ thÃ´ng tin user vÃ  quyá»n
  debug:
    msg: |
      ğŸ‘¤ User Information:
      - Current user: {{ current_user.stdout }}
      - User ID: {{ user_id.stdout }}
      - Is root: {{ (user_id.stdout == '0') | ternary('Yes', 'No') }}
      - Sudo available: {{ (sudo_check.rc == 0) | ternary('Yes', 'No') }}
      - Become method: {{ ansible_become_method | default('not configured') }}
      - Become user: {{ ansible_become_user | default('not configured') }}
  tags: [validation, permissions]

- name: Cáº£nh bÃ¡o náº¿u khÃ´ng pháº£i root vÃ  khÃ´ng cÃ³ sudo
  fail:
    msg: |
      âŒ INSUFFICIENT PERMISSIONS
      
      ğŸ“‹ Current Status:
      - User: {{ current_user.stdout }}
      - User ID: {{ user_id.stdout }}
      - Root access: {{ (user_id.stdout == '0') | ternary('Direct', 'No') }}
      - Sudo access: {{ (sudo_check.rc == 0) | ternary('Available', 'Not available') }}
      - Become configured: {{ ansible_become | default('Not configured') }}
      
      ğŸ”§ Solutions:
      1. Enable passwordless sudo for user '{{ current_user.stdout }}':
         echo "{{ current_user.stdout }} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/{{ current_user.stdout }}
      
      2. Run with sudo password prompt:
         ansible-playbook install-mysql.yml -b -K
      
      3. Update inventory with proper user:
         [mysql_servers]
         server1 ansible_host=IP ansible_user={{ current_user.stdout }} ansible_become=yes
      
      4. Test sudo access:
         ansible mysql_servers -m command -a "sudo whoami"
      
      âš ï¸  MySQL installation requires administrative privileges for:
      - Installing system packages and dependencies
      - Creating mysql user and group
      - Configuring systemd services
      - Modifying system configuration files (/etc)
      - Setting up OS optimizations (kernel parameters)
      - Managing firewall rules
  when: 
    - user_id.stdout != '0'
    - sudo_check.rc != 0
    - not ansible_become | default(false)
  tags: [validation, permissions]

- name: ThÃ´ng bÃ¡o thÃ nh cÃ´ng vá» quyá»n
  debug:
    msg: |
      âœ… PERMISSION CHECK PASSED
      
      ğŸ“‹ Access Method:
      {% if user_id.stdout == '0' %}
      - Running as root user (UID 0)
      - Direct administrative access available
      {% elif sudo_check.rc == 0 %}
      - Running as user '{{ current_user.stdout }}' with sudo access
      - Will escalate privileges using sudo when needed
      - Recommended: Enable passwordless sudo for automation
      {% elif ansible_become | default(false) %}
      - Running with Ansible become configured
      - Will use '{{ ansible_become_method | default('sudo') }}' for privilege escalation
      {% endif %}
      
      ğŸ’¡ Best Practice for Non-Root User:
      - Ensure passwordless sudo is configured
      - Test: ansible mysql_servers -m command -a "sudo whoami"
      - Expected output: root
      
      ğŸ”§ Ready to proceed with MySQL installation
  when: 
    - user_id.stdout == '0' or sudo_check.rc == 0 or ansible_become | default(false)
  tags: [validation, permissions]

- name: Cáº£nh bÃ¡o cho environment production vá»›i user thÆ°á»ng
  debug:
    msg: |
      âœ… PRODUCTION SECURITY BEST PRACTICE
      
      You are using a non-root user with sudo access for MySQL installation.
      This is the RECOMMENDED security approach for production!
      
      ğŸ”’ Security Benefits:
      1. âœ… Principle of least privilege
      2. âœ… Reduced attack surface
      3. âœ… Audit trail through sudo logs
      4. âœ… Granular permission control
      
      ğŸ“‹ Verify Configuration:
      1. âœ… User '{{ current_user.stdout }}' has sudo access
      2. âœ… Passwordless sudo configured for automation
      3. âœ… SSH key authentication (not passwords)
      4. âœ… User has appropriate groups (sudo, admin)
      
      ğŸ’¡ Additional Security Recommendations:
      - Limit sudo access to specific commands if possible
      - Enable sudo logging: /var/log/auth.log
      - Consider using dedicated MySQL service account
      - Implement proper key rotation policies
      
      ğŸ”§ Permissions for MySQL Installation:
      - Package installation: âœ… sudo apt/yum
      - User/Group creation: âœ… sudo groupadd/useradd
      - Service management: âœ… sudo systemctl
      - File permissions: âœ… sudo chown/chmod
      - OS tuning: âœ… sudo sysctl
  when: 
    - mysql_environment == 'prod'
    - user_id.stdout != '0'
    - sudo_check.rc == 0 or ansible_become | default(false)
  tags: [validation, permissions, security]

- name: Kiá»ƒm tra quyá»n ghi vÃ o thÆ° má»¥c quan trá»ng
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /tmp/mysql-ansible-test
  register: directory_test
  failed_when: false
  tags: [validation, permissions]

- name: Dá»n dáº¹p test directory
  file:
    path: /tmp/mysql-ansible-test
    state: absent
  tags: [validation, permissions]

- name: Cáº£nh bÃ¡o náº¿u khÃ´ng thá»ƒ táº¡o directory
  debug:
    msg: |
      âš ï¸  WARNING: Directory creation test failed
      
      This might indicate insufficient permissions for MySQL installation.
      Proceeding anyway, but installation might fail later.
      
      Consider checking filesystem permissions and disk space.
  when: directory_test.failed | default(false)
  tags: [validation, permissions]

- name: Kiá»ƒm tra cÃ¡c lá»‡nh cáº§n thiáº¿t cÃ³ sáºµn khÃ´ng
  command: which {{ item }}
  register: command_check
  failed_when: false
  changed_when: false
  loop:
    - sudo
    - systemctl
    - wget
    - tar
    - groupadd
    - useradd
  tags: [validation, commands]

- name: BÃ¡o cÃ¡o cÃ¡c lá»‡nh thiáº¿u
  debug:
    msg: |
      ğŸ“‹ Command Availability Check:
      {% for result in command_check.results %}
      - {{ result.item }}: {{ (result.rc == 0) | ternary('âœ… Available', 'âŒ Missing') }}
      {% endfor %}
      
      {% if command_check.results | selectattr('rc', 'ne', 0) | list | length > 0 %}
      âš ï¸  Some required commands are missing. Installation may fail.
      {% else %}
      âœ… All required commands are available.
      {% endif %}
  tags: [validation, commands]

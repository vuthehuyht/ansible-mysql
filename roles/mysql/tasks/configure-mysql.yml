---
# Tasks ƒë·ªÉ t·∫°o c·∫•u h√¨nh MySQL v√† systemd service

- name: T·∫°o file c·∫•u h√¨nh MySQL /etc/my.cnf
  template:
    src: my.cnf.j2
    dest: /etc/my.cnf
    owner: root
    group: root
    mode: '0644'
    backup: yes

- name: T·∫°o th∆∞ m·ª•c /var/run/mysqld
  file:
    path: /var/run/mysqld
    state: directory
    owner: mysql
    group: mysql
    mode: '0755'

- name: T·∫°o systemd service file cho MySQL
  template:
    src: mysqld.service.j2
    dest: /etc/systemd/system/mysqld.service
    owner: root
    group: root
    mode: '0644'
    backup: yes

- name: T·∫°o mysqld_safe_helper script
  template:
    src: mysqld_safe_helper.j2
    dest: "{{ mysql_install_dir }}/bin/mysqld_safe_helper"
    owner: root
    group: root
    mode: '0755'

- name: T·∫°o symlink cho systemd service
  file:
    src: /etc/systemd/system/mysqld.service
    dest: /etc/systemd/system/mysql.service
    state: link

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable v√† start MySQL service
  systemd:
    name: mysql
    enabled: yes
    state: started
    daemon_reload: yes
  register: mysql_service_start

- name: Ch·ªù MySQL service kh·ªüi ƒë·ªông ho√†n to√†n
  wait_for:
    port: "{{ mysql_port }}"
    host: 127.0.0.1
    delay: 5
    timeout: 60

- name: Ki·ªÉm tra MySQL service status
  systemd:
    name: mysql
  register: mysql_service_status

- name: Hi·ªÉn th·ªã tr·∫°ng th√°i MySQL service
  debug:
    msg: |
      üîß MySQL Service Configuration Complete:
      - Service: {{ mysql_service_status.status.ActiveState }}
      - Enabled: {{ mysql_service_status.status.UnitFileState }}
      - Config: /etc/my.cnf
      - Service file: /etc/systemd/system/mysqld.service
      - Port: {{ mysql_port }}

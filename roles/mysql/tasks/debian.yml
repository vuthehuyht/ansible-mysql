---
# Tasks c√†i ƒë·∫∑t MySQL 8.0.42 t·ª´ binary tr√™n Ubuntu/Debian
- name: C·∫≠p nh·∫≠t apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: C√†i ƒë·∫∑t c√°c packages c·∫ßn thi·∫øt
  apt:
    name:
      - wget
      - tar
      - libaio1
      - libnuma1
      - python3-pymysql
      - libmecab2
      - libtinfo5  # Ubuntu 24.04 compatibility
      - libssl3    # Updated SSL library
    state: present

- name: T·∫°o th∆∞ m·ª•c t·∫°m ƒë·ªÉ t·∫£i MySQL
  file:
    path: /tmp/mysql-install
    state: directory
    mode: '0755'

- name: T·∫£i MySQL 8.0.42 binary t·ª´ MySQL website
  get_url:
    url: "https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.42-linux-glibc2.28-x86_64.tar.xz"
    dest: /tmp/mysql-install/mysql-8.0.42-linux-glibc2.28-x86_64.tar.xz
    mode: '0644'
    timeout: 300
  register: mysql_download
  retries: 3
  delay: 10

- name: Hi·ªÉn th·ªã k·∫øt qu·∫£ download
  debug:
    msg: "üì¶ MySQL binary: {{ (mysql_download.stat.size / 1024 / 1024) | round(2) if mysql_download.stat is defined else 'Unknown' }} MB"

- name: Ki·ªÉm tra n·∫øu MySQL ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t tr∆∞·ªõc ƒë√≥
  stat:
    path: /usr/local/mysql
  register: mysql_existing_install

- name: Backup MySQL c≈© n·∫øu t·ªìn t·∫°i
  shell: |
    if [ -d "/usr/local/mysql" ]; then
      mv /usr/local/mysql /usr/local/mysql.backup.$(date +%Y%m%d_%H%M%S)
      echo "Backed up existing MySQL installation"
    else
      echo "No existing MySQL installation found"
    fi
  register: backup_result
  when: mysql_existing_install.stat.exists

- name: Hi·ªÉn th·ªã k·∫øt qu·∫£ backup
  debug:
    msg: "{{ backup_result.stdout }}"
  when: mysql_existing_install.stat.exists

- name: Gi·∫£i n√©n MySQL binary
  unarchive:
    src: /tmp/mysql-install/mysql-8.0.42-linux-glibc2.28-x86_64.tar.xz
    dest: /tmp/mysql-install/
    remote_src: yes
    creates: /tmp/mysql-install/mysql-8.0.42-linux-glibc2.28-x86_64

- name: Di chuy·ªÉn MySQL ƒë·∫øn /usr/local/mysql
  shell: |
    mv /tmp/mysql-install/mysql-8.0.42-linux-glibc2.28-x86_64 /usr/local/mysql
    echo "MySQL moved to /usr/local/mysql"
  args:
    creates: /usr/local/mysql

- name: T·∫°o MySQL group
  group:
    name: "{{ mysql_group }}"
    state: present

- name: T·∫°o MySQL user
  user:
    name: "{{ mysql_user }}"
    group: "{{ mysql_group }}"
    system: yes
    shell: /bin/false
    home: "{{ mysql_basedir }}"
    create_home: no
    state: present

- name: T·∫°o th∆∞ m·ª•c mysql-files
  file:
    path: "{{ mysql_basedir }}/mysql-files"
    state: directory
    owner: "{{ mysql_user }}"
    group: "{{ mysql_group }}"
    mode: '0750'

- name: T·∫°o th∆∞ m·ª•c data
  file:
    path: "{{ mysql_datadir }}"
    state: directory
    owner: "{{ mysql_user }}"
    group: "{{ mysql_group }}"
    mode: '0750'

- name: T·∫°o th∆∞ m·ª•c logs
  file:
    path: /var/log/mysql
    state: directory
    owner: "{{ mysql_user }}"
    group: "{{ mysql_group }}"
    mode: '0755'

- name: Thi·∫øt l·∫≠p quy·ªÅn cho MySQL directory
  file:
    path: "{{ mysql_basedir }}"
    owner: "{{ mysql_user }}"
    group: "{{ mysql_group }}"
    recurse: yes
    state: directory

- name: Kh·ªüi t·∫°o MySQL database
  shell: |
    cd {{ mysql_basedir }}
    ./bin/mysqld --initialize --user={{ mysql_user }} --datadir={{ mysql_datadir }}
  register: mysql_init_result
  args:
    creates: "{{ mysql_datadir }}/mysql"

- name: L·∫•y temporary root password t·ª´ log
  shell: |
    grep 'temporary password' /var/log/mysql/error.log | awk '{print $NF}' | tail -1
  register: mysql_temp_password
  failed_when: false
  changed_when: false

- name: Hi·ªÉn th·ªã th√¥ng tin kh·ªüi t·∫°o
  debug:
    msg: "‚úÖ MySQL initialized | Root password: {{ mysql_temp_password.stdout if mysql_temp_password.stdout else 'Set during secure installation' }}"

- name: T·∫°o symlink cho MySQL commands
  file:
    src: "{{ mysql_basedir }}/bin/{{ item }}"
    dest: /usr/local/bin/{{ item }}
    state: link
  loop:
    - mysql
    - mysqldump
    - mysqladmin
    - mysqlcheck
  ignore_errors: yes

- name: C·∫≠p nh·∫≠t PATH trong /etc/environment
  lineinfile:
    path: /etc/environment
    regexp: '^PATH='
    line: 'PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:{{ mysql_basedir }}/bin"'
    backup: yes

- name: Hi·ªÉn th·ªã tr·∫°ng th√°i c√†i ƒë·∫∑t
  debug:
    msg: "üéâ MySQL 8.0.42 installed: {{ mysql_basedir }} | Data: {{ mysql_datadir }}"

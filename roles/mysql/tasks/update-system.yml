---
# Tasks Ä‘á»ƒ cáº­p nháº­t vÃ  upgrade há»‡ thá»‘ng Ubuntu/Debian trÆ°á»›c khi cÃ i Ä‘áº·t MySQL

- name: Kiá»ƒm tra OS Ä‘Æ°á»£c há»— trá»£
  fail:
    msg: "âŒ {{ ansible_distribution }} khÃ´ng Ä‘Æ°á»£c há»— trá»£! Chá»‰ há»— trá»£ Ubuntu/Debian."
  when: ansible_os_family != "Debian"

- name: Hiá»ƒn thá»‹ thÃ´ng tin há»‡ thá»‘ng trÆ°á»›c khi cáº­p nháº­t
  debug:
    msg: "ğŸ”„ Updating {{ ansible_distribution }} {{ ansible_distribution_version }} ({{ ansible_architecture }})"

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  register: apt_update_result
  retries: 3
  delay: 10

- name: Hiá»ƒn thá»‹ káº¿t quáº£ apt update
  debug:
    msg: "âœ… Apt cache updated successfully"
  when: apt_update_result is succeeded

- name: Hiá»ƒn thá»‹ packages cÃ³ thá»ƒ upgrade
  shell: apt list --upgradable 2>/dev/null | wc -l
  register: upgradable_count
  changed_when: false

- name: ThÃ´ng bÃ¡o sá»‘ packages sáº½ upgrade
  debug:
    msg: "ğŸ“¦ CÃ³ {{ (upgradable_count.stdout | int) - 1 }} packages sáº½ Ä‘Æ°á»£c upgrade"

- name: Upgrade táº¥t cáº£ packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  register: apt_upgrade_result
  async: 3600  # Timeout sau 1 giá»
  poll: 30     # Kiá»ƒm tra má»—i 30 giÃ¢y

- name: Hiá»ƒn thá»‹ thá»‘ng kÃª upgrade
  debug:
    msg: "âœ… Upgrade completed: {{ apt_upgrade_result.stdout_lines | length if apt_upgrade_result.stdout_lines is defined else 0 }} packages"
  when: apt_upgrade_result is finished

- name: Kiá»ƒm tra náº¿u cáº§n reboot
  stat:
    path: /var/run/reboot-required
  register: reboot_required_ubuntu

- name: Cáº£nh bÃ¡o náº¿u cáº§n reboot
  debug:
    msg: "âš ï¸  Cáº¢NH BÃO: Há»‡ thá»‘ng cáº§n reboot sau khi upgrade! Vui lÃ²ng reboot sau khi hoÃ n thÃ nh cÃ i Ä‘áº·t MySQL."
  when: reboot_required_ubuntu.stat.exists

# Common tasks sau khi update
- name: Kiá»ƒm tra disk space sau khi upgrade
  shell: df -h /
  register: disk_space_result
  changed_when: false

- name: Hiá»ƒn thá»‹ disk space
  debug:
    msg: "ğŸ’¾ Disk space: {{ disk_space_result.stdout.split('\n')[0] if disk_space_result.stdout else 'Unknown' }}"

- name: Táº¡o checkpoint trÆ°á»›c khi cÃ i Ä‘áº·t MySQL
  shell: |
    echo "System updated on $(date)" > /tmp/ansible-mysql-update.log
    echo "Kernel: $(uname -r)" >> /tmp/ansible-mysql-update.log
    echo "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}" >> /tmp/ansible-mysql-update.log
  changed_when: false

- name: Pause 10 giÃ¢y Ä‘á»ƒ há»‡ thá»‘ng á»•n Ä‘á»‹nh
  pause:
    seconds: 10
    prompt: "Äang chá» há»‡ thá»‘ng á»•n Ä‘á»‹nh sau upgrade..."

- name: ThÃ´ng bÃ¡o hoÃ n thÃ nh system update
  debug:
    msg: "âœ… System updated | {{ ansible_distribution }} {{ ansible_distribution_version }} | Ready for MySQL"

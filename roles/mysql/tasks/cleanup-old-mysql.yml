---
# Tasks ƒë·ªÉ ki·ªÉm tra v√† g·ª° b·ªè MySQL c≈© tr∆∞·ªõc khi c√†i ƒë·∫∑t phi√™n b·∫£n m·ªõi

- name: Ki·ªÉm tra MySQL ƒë√£ c√†i ƒë·∫∑t
  shell: |
    dpkg -l | grep -i mysql || echo "No MySQL packages found"
  register: existing_mysql_packages
  changed_when: false

- name: Hi·ªÉn th·ªã MySQL packages hi·ªán c√≥ (n·∫øu c√≥)
  debug:
    msg: "üì¶ Found MySQL packages: {{ existing_mysql_packages.stdout_lines | length }} items"
  when: "'mysql' in existing_mysql_packages.stdout.lower()"

- name: Ki·ªÉm tra MySQL service ƒëang ch·∫°y
  systemd:
    name: mysql
  register: mysql_service_check
  ignore_errors: yes

- name: Hi·ªÉn th·ªã tr·∫°ng th√°i MySQL service hi·ªán t·∫°i
  debug:
    msg: "üîß MySQL service: {{ mysql_service_check.status.ActiveState if mysql_service_check.status is defined else 'Not installed' }}"
  when: mysql_service_check.status is defined

- name: Backup d·ªØ li·ªáu MySQL c≈© (n·∫øu c√≥)
  block:
    - name: T·∫°o th∆∞ m·ª•c backup
      file:
        path: /tmp/mysql_backup_before_reinstall
        state: directory
        mode: '0755'

    - name: Backup all databases
      shell: |
        mysqldump -u root -p{{ mysql_root_password | default('') }} --all-databases > /tmp/mysql_backup_before_reinstall/all-databases-$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || \
        mysqldump --all-databases > /tmp/mysql_backup_before_reinstall/all-databases-$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || \
        echo "Could not backup - MySQL may not be configured or accessible"
      register: backup_result
      ignore_errors: yes

    - name: Hi·ªÉn th·ªã k·∫øt qu·∫£ backup
      debug:
        msg: "üíæ Backup: {{ backup_result.stdout if backup_result.stdout else 'Failed or not needed' }}"
  when: 
    - mysql_service_check.status is defined
    - mysql_service_check.status.ActiveState == "active"

- name: D·ª´ng MySQL service n·∫øu ƒëang ch·∫°y
  systemd:
    name: mysql
    state: stopped
  ignore_errors: yes
  when: 
    - mysql_service_check.status is defined
    - mysql_service_check.status.ActiveState == "active"

- name: G·ª° b·ªè t·∫•t c·∫£ MySQL packages
  apt:
    name:
      - mysql-server
      - mysql-server-*
      - mysql-client
      - mysql-client-*
      - mysql-common
      - mysql-community-server
      - mysql-community-client
      - mariadb-server
      - mariadb-client
      - mariadb-common
    state: absent
    purge: yes
  register: mysql_removal
  ignore_errors: yes

- name: Hi·ªÉn th·ªã k·∫øt qu·∫£ g·ª° b·ªè packages
  debug:
    msg: "üóëÔ∏è Removed {{ mysql_removal.stdout_lines | length if mysql_removal.stdout_lines is defined else 0 }} packages"

- name: X√≥a MySQL configuration files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/mysql
    - /etc/mysqld.conf
    - /etc/my.cnf
    - /etc/mysql/my.cnf
    - /etc/mysql/mysql.conf.d
    - /var/lib/mysql-files
    - /var/lib/mysql-keyring
    - /usr/local/mysql.backup.*
  ignore_errors: yes

- name: X√≥a systemd service files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/systemd/system/mysqld.service
    - /etc/systemd/system/mysql.service
  ignore_errors: yes

- name: Reload systemd daemon sau khi x√≥a services
  systemd:
    daemon_reload: yes

- name: Ki·ªÉm tra MySQL data directory
  stat:
    path: /var/lib/mysql
  register: mysql_data_dir

- name: Ki·ªÉm tra MySQL binary installation
  stat:
    path: /usr/local/mysql
  register: mysql_binary_install

- name: Backup v√† x√≥a MySQL data directory n·∫øu c√≥
  block:
    - name: T·∫°o backup c·ªßa data directory
      shell: |
        if [ -d "/var/lib/mysql" ]; then
          tar -czf /tmp/mysql_backup_before_reinstall/mysql-data-$(date +%Y%m%d_%H%M%S).tar.gz -C /var/lib mysql/
          echo "Data directory backed up"
        else
          echo "No data directory found"
        fi
      register: data_backup_result

    - name: Hi·ªÉn th·ªã k·∫øt qu·∫£ backup data
      debug:
        msg: "üìÅ {{ data_backup_result.stdout }}"

    - name: X√≥a MySQL data directory
      file:
        path: /var/lib/mysql
        state: absent
      when: mysql_data_dir.stat.exists

  when: mysql_data_dir.stat.exists

- name: Backup v√† x√≥a MySQL binary installation n·∫øu c√≥
  block:
    - name: T·∫°o backup c·ªßa binary installation
      shell: |
        if [ -d "/usr/local/mysql" ]; then
          tar -czf /tmp/mysql_backup_before_reinstall/mysql-binary-$(date +%Y%m%d_%H%M%S).tar.gz -C /usr/local mysql/
          echo "Binary installation backed up"
        else
          echo "No binary installation found"
        fi
      register: binary_backup_result

    - name: Hi·ªÉn th·ªã k·∫øt qu·∫£ backup binary
      debug:
        msg: "üìÅ {{ binary_backup_result.stdout }}"

    - name: X√≥a MySQL binary installation
      file:
        path: /usr/local/mysql
        state: absent
      when: mysql_binary_install.stat.exists

  when: mysql_binary_install.stat.exists

- name: X√≥a MySQL symlinks t·ª´ /usr/local/bin
  file:
    path: /usr/local/bin/{{ item }}
    state: absent
  loop:
    - mysql
    - mysqldump
    - mysqladmin
    - mysqlcheck
  ignore_errors: yes

- name: X√≥a MySQL log files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/log/mysql
    - /var/log/mysql.log
    - /var/log/mysql.err
    - /var/log/mysqld.log
  ignore_errors: yes

- name: X√≥a MySQL user v√† group
  block:
    - name: X√≥a MySQL user
      user:
        name: mysql
        state: absent
        remove: yes
      ignore_errors: yes

    - name: X√≥a MySQL group
      group:
        name: mysql
        state: absent
      ignore_errors: yes

- name: L√†m s·∫°ch package cache
  apt:
    autoclean: yes
    autoremove: yes

- name: C·∫≠p nh·∫≠t package database
  apt:
    update_cache: yes

- name: Ki·ªÉm tra l·∫°i MySQL packages sau khi cleanup
  shell: |
    dpkg -l | grep -i mysql || echo "‚úÖ No MySQL packages found - cleanup successful"
  register: cleanup_verification
  changed_when: false

- name: Hi·ªÉn th·ªã k·∫øt qu·∫£ cleanup
  debug:
    msg: |
      üßπ CLEANUP HO√ÄN TH√ÄNH
      =====================
      {{ cleanup_verification.stdout }}
      
      üìã C√°c files ƒë√£ ƒë∆∞·ª£c backup t·∫°i:
      - /tmp/mysql_backup_before_reinstall/
      
      ‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng cho MySQL 8.0.42 m·ªõi
      =====================

- name: Pause ƒë·ªÉ ƒë·∫£m b·∫£o h·ªá th·ªëng ·ªïn ƒë·ªãnh
  pause:
    seconds: 5
    prompt: "Ch·ªù h·ªá th·ªëng ·ªïn ƒë·ªãnh sau cleanup..."
